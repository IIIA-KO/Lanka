<div class="dashboard-container fade-in-up">
  <!-- Header -->
  <header class="page-header mb-4">
    <h1>{{ 'PACT.TITLE' | translate }}</h1>
    <p class="subtitle">
      {{ 'PACT.SUBTITLE' | translate }}
    </p>
  </header>

  <div *ngIf="loading && !pact && !isEditing" class="loading-state text-color-secondary">
    Loading pact...
  </div>

  <div *ngIf="error && !isEditing" class="error-banner mb-4">
    <p-message severity="error" [text]="error"></p-message>
    <button pButton (click)="loadPact()" class="p-button-text">Retry</button>
  </div>

  <!-- Create State (No Pact) -->
  <div *ngIf="!loading && !pact && !isEditing && !error" class="empty-state">
    <div class="empty-card">
      <i class="pi pi-file-edit text-primary text-6xl mb-4"></i>
      <h3>Create Your Partnership Agreement</h3>
      <p>Define your standard terms and expectations for brand collaborations.</p>
      <button pButton icon="pi pi-plus" (click)="startEditing()" class="mt-4">Create Pact</button>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div *ngIf="!loading && (pact || isEditing)" class="grid">

    <!-- LEFT COLUMN: Pact Content / Editor (Matches Profile 'Main Content') -->
    <main class="col-12 lg:col-8">
      <div class="card-style">

        <!-- View Mode Header -->
        <div class="flex justify-content-between align-items-center mb-4" *ngIf="!isEditing">
          <h3 class="text-xl font-bold m-0">Agreement Terms</h3>
          <button pButton icon="pi pi-pencil" class="p-button-text" (click)="startEditing()">Edit</button>
        </div>

        <!-- Edit Mode Header -->
        <div class="flex justify-content-between align-items-center mb-4" *ngIf="isEditing">
          <h3 class="text-xl font-bold m-0">{{ pact ? 'Edit Terms' : 'Draft Terms' }}</h3>
          <p-selectButton [options]="editModeOptions" [(ngModel)]="activeEditMode" optionLabel="label"
            optionValue="value"></p-selectButton>
        </div>

        <!-- View Content -->
        <div class="markdown-body" *ngIf="!isEditing && pact" [innerHTML]="getParsedContent(pact.content)"></div>

        <!-- Edit Form -->
        <form [formGroup]="pactForm" (ngSubmit)="onSubmit()" *ngIf="isEditing" class="edit-form">
          <!-- Write Mode -->
          <div class="field" *ngIf="activeEditMode === 'write'">
            <div class="markdown-toolbar">
              <button type="button" class="tool-btn" (click)="insertMarkdown('**', '**')" pTooltip="Bold"
                aria-label="Bold"><i class="pi pi-bold"></i></button>
              <button type="button" class="tool-btn" (click)="insertMarkdown('*', '*')" pTooltip="Italic"
                aria-label="Italic"><i class="pi pi-italic"></i></button>
              <div class="divider"></div>
              <button type="button" class="tool-btn" (click)="insertMarkdown('## ')" pTooltip="Heading"
                aria-label="Heading"><i class="pi pi-hashtag"></i></button>
              <button type="button" class="tool-btn" (click)="insertMarkdown('* ')" pTooltip="List" aria-label="List"><i
                  class="pi pi-list"></i></button>
            </div>

            <textarea pTextarea id="content" formControlName="content" rows="20" class="editor-textarea"
              placeholder="Start typing your terms..."></textarea>

            <div class="form-footer">
              <span class="char-count">{{ pactForm.get('content')?.value?.length || 0 }} chars</span>
              <button *ngIf="!pact" type="button" class="reset-link" (click)="resetToSample()">Use Template</button>
            </div>
          </div>

          <!-- Preview Mode -->
          <div class="preview-mode markdown-body" *ngIf="activeEditMode === 'preview'"
            [innerHTML]="getParsedContent(pactForm.get('content')?.value || '')"></div>

          <div class="form-actions">
            <button pButton type="button" class="p-button-text" (click)="cancelEditing()"
              [disabled]="loading">Cancel</button>
            <button pButton type="submit" [loading]="loading">{{ pact ? 'Save Changes' : 'Create Pact' }}</button>
          </div>
        </form>
      </div>
    </main>

    <!-- RIGHT COLUMN: Offers Sidebar (Matches Profile 'Sidebar') -->
    <aside class="col-12 lg:col-4" *ngIf="!isEditing && pact">
      <div class="card-style">
        <div class="flex justify-content-between align-items-center mb-4">
          <h3 class="text-xl font-bold m-0">{{ 'OFFERS.LIST_TITLE' | translate }}</h3>
          <button pButton icon="pi pi-plus" class="p-button-rounded p-button-text" (click)="navigateToCreateOffer()"
            [pTooltip]="'OFFERS.NEW' | translate"><span class="hidden">New Offer</span></button>
        </div>

        <!-- Offer Item -->
        <div class="offers-list" *ngIf="pact.offers && pact.offers.length > 0; else noOffers">
          <div *ngFor="let offer of pact.offers" class="offer-item" (click)="navigateToOfferEdit(offer.id)"
            (keydown.enter)="navigateToOfferEdit(offer.id)" tabindex="0" role="button">
            <div class="offer-info">
              <span class="offer-name">{{ offer.name }}</span>
              <span class="offer-price">{{ offer.priceAmount | currency:offer.priceCurrency }}</span>
            </div>
            <button pButton icon="pi pi-chevron-right" class="p-button-text p-button-sm action-btn"
              [attr.aria-label]="'OFFERS.FORM.EDIT_TITLE' | translate"><span class="hidden">Edit</span></button>
          </div>
        </div>

        <ng-template #noOffers>
          <div class="empty-sidebar text-center text-color-secondary py-4">
            <p>{{ 'OFFERS.EMPTY' | translate }}</p>
            <button pButton class="p-button-outlined p-button-sm" (click)="navigateToCreateOffer()">
              {{ 'OFFERS.CREATE' | translate }}
            </button>
          </div>
        </ng-template>
      </div>
    </aside>

  </div>
</div>
